name: main-flow
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - 03_cd
jobs:
  clone-down:
    runs-on: ubuntu-latest
    steps:
      - name: clone-down
        uses: actions/checkout@v2
         with:
          ref: 03_cd
      - name: Upload Repo
        uses: actions/upload-artifact@v3
        with: 
          name: code
          path: | 
            .
            !.git
  build:
    runs-on: ubuntu-latest
    # container: golang:latest ######
    needs: [Clone-down]
    steps:
      - name: Download Repo
        uses: actions/download-artifact@v3
        with: 
          name: code
          path: .
      - name: build-frontend
        run: cd frontend && go build .    
      - name: build-backend
        run: cd backend &&  go mod download github.com/gomodule/redigo && go build . 
  test:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Download Repo
        uses: actions/download-artifact@v3
        with: 
          name: code
          path: .
      - name: test-front-end
        run: cd frontend && go test .  
  publish:
    runs-on: production
    needs: [test]
    steps:
      - name: Download Repo
        uses: actions/download-artifact@v3
        with: 
          name: code
          path: .
      - name: test-front-end
        run: docker-compose up --build -d  