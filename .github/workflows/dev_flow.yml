name: dev-flow
on:
  push:
    branches:
      - dev/*
jobs:
  clone-down:
    runs-on: production
    steps:
      - name: clone-down
        uses: actions/checkout@v2
      - name: Upload Repo
        uses: actions/upload-artifact@v3
        with: 
          name: code
          path: | 
            .
            !.git
  build:
    runs-on: production
    # container: golang:latest ########
    needs: [Clone-down]
    steps:
      - name: Download Repo
        uses: actions/download-artifact@v3
        with: 
          name: code
          path: .
      - name: build-frontend
        run: cd frontend && go build .    
      - name: build-backend
        run: cd backend &&  go mod download github.com/gomodule/redigo && go build . 
  test:
    runs-on: production
    needs: [build]
    steps:
      - name: Download Repo
        uses: actions/download-artifact@v3
        with: 
          name: code
          path: .
      - name: test-front-end
        run: cd frontend && go test .  
  push-staging:
    runs-on: production
    needs: [test]
    steps:
      - name: Download Repo
        uses: actions/download-artifact@v3
        with: 
          name: code
          path: .
      - name: create-branch
        uses: peterjgrainger/action-create-branch@v2.2.0  
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          branch: 'ready/${{github.ref_name}}'
      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: 'ready/${{github.ref_name}}'
  # pull-request:
  #   runs-on: production
  #   needs: [clone-down]
  #   steps:
  #   - name: Run the Action
  #     uses: devops-infra/action-pull-request@v0.5.0
  #     with:
  #       github_token: ${{ secrets.GITHUB_TOKEN }}
  #       source_branch: ${{github.ref_name}}
  #       target_branch: main